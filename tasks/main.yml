---
- name: Update APT cache
  apt: update_cache=yes cache_valid_time=3600
  when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'

- name: Ensure iptables-persistent is installed
  package: name=iptables-persistent state=present
  remote_user: root

- name: Copy watchdog script
  copy: src=firewall-watchdog.sh dest=/usr/local/sbin/firewall-watchdog owner=root group=root mode=750

- name: Generate iptables rules script
  template: src=firewall.sh.j2 dest=/tmp/firewall.sh owner=root group=root mode="u=rwx,g=rwx,o="

- name: Populate firewall with desired rules
  shell: /tmp/firewall.sh

- name: Save current firewall config
  shell: iptables-save | tee /etc/iptables/rules.v4 | sed -r "s/\[[0-9]+:[0-9]+\]//g" | grep -vE "^#" > /var/lib/ansible-firewall

- name: Add users to sudoers for firewall-watchdog execution
  lineinfile: dest=/etc/sudoers state=present line="zabbix ALL=(ALL) NOPASSWD:/usr/local/sbin/firewall-watchdog" validate='visudo -cf %s'

- name: Check old zabbix_agentd.d directory
  stat: path=/etc/zabbix/zabbix_agentd.d
  register: zabbix_old_path

- name: Check new zabbix_agentd.conf.d directory
  stat: path=/etc/zabbix/zabbix_agentd.conf.d
  register: zabbix_new_path

#- name: Fail if zabbix conf directory was not found
#  when: zabbix_old_path is not defined and zabbix_new_path is not defined
#  fail: msg="Zabbix configuration was not found"

- name: Add firewall.state to zabbix 
  copy: src=firewall-watchdog.conf dest=/etc/zabbix/zabbix_agentd.conf.d/firewall-watchdog.conf owner=root group=root mode=644
  register: fw_zabbix
  when: zabbix_new_path.stat.exists

- name: Add firewall.state to zabbix (old path)
  copy: src=firewall-watchdog.conf dest=/etc/zabbix/zabbix_agentd.d/firewall-watchdog.conf owner=root group=root mode=644
  register: fw_zabbix_old
  when: zabbix_old_path.stat.exists

- name: Restart zabbix
  service: name=zabbix-agent state=restarted
  when: fw_zabbix.changed or fw_zabbix_old.changed


#- name: Remove firewall script
#  file: name=/tmp/firewall.sh state=absent
